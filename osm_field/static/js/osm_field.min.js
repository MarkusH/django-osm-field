(function(e){e.fn.osmfield=function(){return this.each(function(){var t=e(this).attr("id");var n=e(this).data("lat-field");var r=e(this).data("lon-field");if(n===undefined){n="#"+t+"_lat"}else{n="#id_"+n}if(r===undefined){r="#"+t+"_lon"}else{r="#id_"+r}e(this).addClass("osmfield-input");if(!e("#"+t+"-map").length)e(this).before('<div class="osmfield-wrapper"><div id="'+t+'-map"></div></div>');e(this).data("lat-element",e(n));e(this).data("lng-element",e(r));e(this).data("map-element",e("#"+t+"-map"));e(this).data("map-element").addClass("osmfield-map");var i=e(this);var s=L.map(i.data("map-element")[0]).setView([0,0],15);L.tileLayer("https://otile1-s.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,'+' <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>,'+' Imagery Â© <a href="http://www.mapquest.com/">Mapquest</a>',maxZoom:18}).addTo(s);var o=L.marker([0,0],{draggable:true}).addTo(s);var u=i.closest("[lang]").attr("lang");if(u){u=u.split("-");u=u[0]}else u="en";i.data("language",u);(function(t){o.on("dragend",function(n){var r=n.target.getLatLng();s.panTo(r);var i=s.getZoom();var o=t.data("language");var u="https://nominatim.openstreetmap.org/reverse?json_callback=?";t.data("lat-element").val(r.lat);t.data("lng-element").val(r.lng);e.getJSON(u,{format:"json",lat:r.lat,lon:r.lng,zoom:i,addressdetails:0,"accept-language":o},function(e){t.val(e.display_name)})})})(i);i.on("propertychange keyup input paste change",function(){function t(t){var n=t.data("language");var r="https://nominatim.openstreetmap.org/search?json_callback=?";(function(i){e.getJSON(r,{format:"json",q:t.val(),addressdetails:0,"accept-language":n},function(e){if(e.length){var t=e[0].lat;var n=e[0].lon;var r=e[0].display_name;i.data("lat-element").val(t);i.data("lng-element").val(n);var u=new L.LatLng(t,n);o.setLatLng(u);s.panTo(u)}else{i.data("map-element").slideUp();i.data("lat-element").val("");i.data("lng-element").val("")}if(i.is(":focus")&&i.data("lat-element").val()&&i.data("lng-element").val()){i.data("map-element").slideDown(function(){window.dispatchEvent(new Event("resize"))})}else{i.data("map-element").slideUp()}})})(t)}if(e(this).data("oldvalue")==e(this).val())return;e(this).data("oldvalue",e(this).val());clearTimeout(e.data(this,"timer"));var n=e(this);var r=setTimeout(function(){t(n)},500);e(this).data("timer",r)});i.data("map-element").hide();if(i.data("lat-element").val()&&i.data("lng-element").val()){var a=new L.LatLng(i.data("lat-element").val(),i.data("lng-element").val());o.setLatLng(a);s.panTo(a)}else{i.trigger("change")}e(document).click(function(t){var n=e(t.target).closest(".osmfield-input, .osmfield-map");if(n.length){if(n.hasClass("osmfield-input")){n=n.data("map-element")}e(".osmfield-map").not(n).slideUp()}else{e(".osmfield-map").slideUp()}});(function(e){e.focus(function(){if(e.data("lat-element").val()&&e.data("lng-element").val()){e.data("map-element").slideDown(function(){window.dispatchEvent(new Event("resize"))})}})})(i)})}})(jQuery)
