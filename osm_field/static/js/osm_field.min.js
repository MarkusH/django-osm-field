(function(e){e.fn.osmfield=function(){return this.each(function(){var t=e(this).attr("id");e(this).addClass("osmfield-input");if(!e("#"+t+"-map").length)e(this).before('<div class="osmfield-wrapper"><div id="'+t+'-map"></div></div>');e(this).data("lat-element",e("#"+t+"_lat"));e(this).data("lng-element",e("#"+t+"_lon"));e(this).data("map-element",e("#"+t+"-map"));e(this).data("map-element").addClass("osmfield-map");var n=e(this);var r=L.map(n.data("map-element")[0]).setView([0,0],15);L.tileLayer("http://otile1.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,'+' <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>,'+' Imagery Â© <a href="http://www.mapquest.com/">Mapquest</a>',maxZoom:18}).addTo(r);var i=L.marker([0,0],{draggable:true}).addTo(r);var s=n.closest("[lang]").attr("lang");if(s){s=s.split("-");s=s[0]}else s="en";n.data("language",s);(function(t){i.on("dragend",function(n){var i=n.target.getLatLng();r.panTo(i);var s=r.getZoom();var o=t.data("language");var u="https://nominatim.openstreetmap.org/reverse?json_callback=?";t.data("lat-element").val(i.lat);t.data("lng-element").val(i.lng);e.getJSON(u,{format:"json",lat:i.lat,lon:i.lng,zoom:s,addressdetails:0,"accept-language":o},function(e){t.val(e.display_name)})})})(n);n.on("propertychange keyup input paste change",function(){function t(t){var n=t.data("language");var s="https://nominatim.openstreetmap.org/search?json_callback=?";(function(o){e.getJSON(s,{format:"json",q:t.val(),addressdetails:0,"accept-language":n},function(e){if(e.length){var t=e[0].lat;var n=e[0].lon;var s=e[0].display_name;o.data("lat-element").val(t);o.data("lng-element").val(n);var u=new L.LatLng(t,n);i.setLatLng(u);r.panTo(u)}else{o.data("map-element").slideUp();o.data("lat-element").val("");o.data("lng-element").val("")}if(o.is(":focus")&&o.data("lat-element").val()&&o.data("lng-element").val()){o.data("map-element").slideDown()}else{o.data("map-element").slideUp()}})})(t)}if(e(this).data("oldvalue")==e(this).val())return;e(this).data("oldvalue",e(this).val());clearTimeout(e.data(this,"timer"));var n=e(this);var s=setTimeout(function(){t(n)},500);e(this).data("timer",s)});n.data("map-element").hide();if(n.data("lat-element").val()&&n.data("lng-element").val()){var o=new L.LatLng(n.data("lat-element").val(),n.data("lng-element").val());i.setLatLng(o);r.panTo(o)}else{n.trigger("change")}e(document).click(function(t){var n=e(t.target).closest(".osmfield-input, .osmfield-map");if(n.length){if(n.hasClass("osmfield-input")){n=n.data("map-element")}e(".osmfield-map").not(n).slideUp()}else{e(".osmfield-map").slideUp()}});(function(e){e.focus(function(){if(e.data("lat-element").val()&&e.data("lng-element").val()){e.data("map-element").slideDown()}})})(n)})}})(jQuery)