!function(a){a.fn.osmfield=function(){return this.each(function(){var b,c,d,e=a(this).attr("id"),f=a(this).data("lat-field"),g=a(this).data("lon-field"),h=a(this).data("data-field"),i=a(this);if(f=void 0===f?"#"+e+"_lat":"#id_"+f,g=void 0===g?"#"+e+"_lon":"#id_"+g,h=void 0===h?"#"+e+"_data":"#id_"+h,a(this).addClass("osmfield-input"),a("#"+e+"-map").length||a(this).before('<div class="osmfield-wrapper"><div id="'+e+'-map"></div></div>'),a(this).data("lat-element",a(f)),a(this).data("lng-element",a(g)),a(this).data("data-element",a(h)),a(this).data("map-element",a("#"+e+"-map")),a(this).data("map-element").addClass("osmfield-map"),c=L.map(i.data("map-element")[0]).setView([0,0],15),L.tileLayer("https://otile1-s.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery \xa9 <a href="http://www.mapquest.com/">Mapquest</a>',maxZoom:18}).addTo(c),d=L.marker([0,0],{draggable:!0}).addTo(c),b=i.closest("[lang]").attr("lang"),b?(b=b.split("-"),b=b[0]):b="en",i.data("language",b),function(b){d.on("dragend",function(d){var e=b.data("language"),f=d.target.getLatLng(),g="https://nominatim.openstreetmap.org/reverse?json_callback=?",h=c.getZoom();c.panTo(f),b.data("lat-element").val(f.lat),b.data("lng-element").val(f.lng),a.getJSON(g,{format:"json",lat:f.lat,lon:f.lng,zoom:h,addressdetails:1,"accept-language":e},function(a){b.val(a.display_name),b.data("data-element").val(JSON.stringify(a))})})}(i),i.on("propertychange keyup input paste change",function(){function b(b){var e=b.data("language"),f="https://nominatim.openstreetmap.org/search?json_callback=?";!function(g){a.getJSON(f,{format:"json",q:b.val(),addressdetails:1,"accept-language":e},function(a){if(a.length){var b=a[0].lat,e=a[0].lon,f=new L.LatLng(b,e),h=JSON.stringify(a[0]);g.data("lat-element").val(b),g.data("lng-element").val(e),g.data("data-element").val(h),d.setLatLng(f),c.panTo(f)}else g.data("map-element").slideUp(),g.data("lat-element").val(""),g.data("lng-element").val(""),g.data("data-element").val("");g.is(":focus")&&g.data("lat-element").val()&&g.data("lng-element").val()?g.data("map-element").slideDown(function(){window.dispatchEvent(new Event("resize"))}):g.data("map-element").slideUp()})}(b)}if(a(this).data("oldvalue")!==a(this).val()){a(this).data("oldvalue",a(this).val()),clearTimeout(a.data(this,"timer"));var e=a(this),f=setTimeout(function(){b(e)},500);a(this).data("timer",f)}}),i.data("map-element").hide(),i.data("lat-element").val()&&i.data("lng-element").val()){var j=new L.LatLng(i.data("lat-element").val(),i.data("lng-element").val());d.setLatLng(j),c.panTo(j)}else i.trigger("change");a(document).click(function(b){var c=a(b.target).closest(".osmfield-input, .osmfield-map");c.length?(c.hasClass("osmfield-input")&&(c=c.data("map-element")),a(".osmfield-map").not(c).slideUp()):a(".osmfield-map").slideUp()}),function(a){a.focus(function(){a.data("lat-element").val()&&a.data("lng-element").val()&&a.data("map-element").slideDown(function(){window.dispatchEvent(new Event("resize"))})})}(i)})}}(jQuery);
